---
title: "IA - projeto"
author: "Arthur Vinicius Tomé Rodrigues, João Victor Barroso Mafra, Jobson Lucas Dias da Silva"
date: "23 de fevereiro de 2018"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
require(ggplot2, quietly = TRUE)
require(dplyr, quietly = TRUE)
require(bnlearn, quietly = TRUE)
require(tidyr)
require(reshape2, quietly = TRUE)
library(knitr, quietly = TRUE)
library(reshape2, quietly = TRUE)

```


## Ler arquivo com dados alunos de cc
```{r, echo=FALSE}
df_alunos_cc = ler_dados("alunos_notas_simplif.csv")
```


## gerando os dados para tornar possível a validação do modelo

```{r}
## 200 significa que o cara tirou 0 (uma forma de diferenciar do 0 que substitui NA)
abaco = ler_dados("abaco.csv")
```


## Define situacao em cada periodo:

```{r}
#se a média foi algum dos valores dessa lista, então reprovou
notas_reprovacao = c(1:49, 200)

classifica_linha <- function(linha){
  periodo <- linha[3]
  if (periodo == 1){
    P1 <- linha[4]
    LP1 <- linha[6]
    IC <- linha[7]
    if (P1 %in% notas_reprovacao || 
        LP1 %in% notas_reprovacao || 
        IC %in% notas_reprovacao){
      return ("Reprovado")
    } else {
      return("Aprovado")
    }
  } else if (periodo == 2){
    P2 <- linha[5]
    LP2 <- linha[8]
    Discreta <- linha[9]
    Grafos <- linha[12]
    if (P2 %in% notas_reprovacao || 
        LP2 %in% notas_reprovacao || 
        Discreta %in% notas_reprovacao || 
        Grafos %in% notas_reprovacao){
      return ("Reprovado")
    } else {
      return("Aprovado")
    }
  } else {
    EDA <- linha[10]
    LEDA <- linha[11]
    TC <- linha[13]
    
    if (EDA %in% notas_reprovacao || 
        LEDA %in% notas_reprovacao || 
        TC %in% notas_reprovacao){
      return ("Reprovado")
    } else {
      return("Aprovado")
    }
    
  }
  
}

abaco$Situacao <- abaco$Periodo

for(i in 1:nrow(abaco)) {
    row <- abaco[i,]
    classificacao <- classifica_linha(row)
    abaco$Situacao[i] <- classificacao
    
}

```


## Range para as notas do modelo caxalau
```{r}
#Gerar o range de até 1 ponto (nesse caso 10 porque foi transformado em inteiro para funcionar na rede bayesiana) para usar no modelo caxalau na hora de filtrar os dados. 
# Por exemplo, se a nota for x = 55, x = 51 ou mesmo x = 50 , então o range será [50,60]. 
# O 100 é o caso especial, logo faremos [90, 100] 
range_notas = function(x) {
  ifelse(x != 100,
        (x - (x %% 10)):(x - (x %% 10) + 10),
        (90:100))
}
```


## Transformar em fatores -> usar rede bayesiana
```{r}
cc_notas_simplificadas = df_alunos_cc

##dados para o modelo gerado pelo R 
col_names = colnames(abaco)
abaco[, col_names] = lapply(abaco[, col_names], factor)

##dados para o modelo usado pelo Caxalau
col_names_simp = colnames(cc_notas_simplificadas)
cc_notas_simplificadas[, col_names_simp] = lapply(cc_notas_simplificadas[, col_names_simp], factor)

```


## Elaborando as relações relevantes
```{r}
#Hill climbing
res <- hc(as.data.frame(abaco))

relations = res$arcs
plot(res)

relations = rbind(relations, 
                  c("Leda", "Situacao"), 
                  c("TC", "Situacao"), 
                  c("Eda", "Situacao"), 
                  c("Grafos", "Situacao"),
                  c("LP1", "Situacao"), 
                  c("P2", "Situacao"), 
                  c("LP2", "Situacao"), 
                  c("P1", "P2"), 
                  c("LP1", "P2"),  
                  c("IC", "P2"),  
                  c("P1", "LP2"), 
                  c("LP1", "LP2"),  
                  c("IC", "LP2"), 
                  c("P1", "Grafos"), 
                  c("LP1", "Grafos"),
                  c("IC", "Leda"), 
                  c("P1", "Leda"), 
                  c("LP1", "Leda"),
                  c("Grafos", "Eda"),
                  c("P2", "Eda"), 
                  c("LP2", "Eda"),
                  c("Discreta", "TC"),
                  c("IC", "TC"), 
                  c("Grafos", "TC")
                  )

res$arcs = relations

plot(res)
```


## Gerar BN para modelo simples para os períodos
```{r}
disciplinas_primeiro_periogo = c("1411174", "1411180", "1411167", "P1", "LP1", "IC")
disciplinas_segundo_periogo = c("1109113", "1411168", "1411181", "1411170", "P2", "LP2", "Discreta", "Grafos")
disciplinas_terceiro_periogo = c("1411179", "1411171", "1411172", "Eda", "Leda", "TC")

res_modelo_simples <- hc(cc_notas_simplificadas)
fittedbn <- bn.fit(res_modelo_simples, data = cc_notas_simplificadas, method="mle")

#todo mundo que colocou, se deu baixo, todo mundo vai ser aprovado. Se deu moderado, coloco alguns randomicos para ser reprovado
prob_reprovar_1st_per_simples = cpquery(fittedbn, 
                                          event = (Situacao == "Reprovado"), 
                                          evidence = (Cod_Disciplina %in% disciplinas_primeiro_periogo))

prob_reprovar_2nd_per_simples = cpquery(fittedbn, 
                                          event = (Situacao == "Reprovado"), 
                                          evidence = (Cod_Disciplina %in% disciplinas_segundo_periogo))


prob_reprovar_3rd_per_simples = cpquery(fittedbn, 
                                          event = (Situacao == "Reprovado"), 
                                          evidence = (Cod_Disciplina %in% disciplinas_terceiro_periogo))

```


## Gerar BN para modelo safatraio para os períodos
```{r, echo=False, quietly = TRUE}
candidatos_p1_medias = df_alunos_cc %>% 
  filter(Cod_Disciplina %in% disciplinas_primeiro_periogo) %>% 
  filter(P1 == 55) %>% select(Matricula)

candidatos = ungroup(abaco) %>% filter(P1 == 55) %>%  select(Matricula)

tmp_alunos = as.array(candidatos$Matricula)

alunos_filtrados = df_alunos_cc %>% filter(Matricula %in% tmp_alunos & 
                                           Cod_Disciplina %in% disciplinas_interesse
                                           )

alunos_selecionados = abaco %>% filter(Matricula %in% tmp_alunos)

fittedbn_safa = bn.fit(res, 
                        data = as.data.frame(abaco), 
                        method="mle")


#todo mundo que colocou, se deu baixo, todo mundo vai ser aprovado. Se deu moderado, coloco alguns randomicos para ser reprovado
#não faz sentido gerar para o primeiro período pq não há pré-requisitos

safa_prob_reprovar_2nd_per = cpquery(fittedbn_safa, 
                                     event = (Situacao == "Reprovado"), 
                                     evidence = (Periodo_Curso == 2))

safa_prob_reprovar_3rd_per = cpquery(fittedbn_safa, 
                                     event = (Situacao == "Reprovado"), 
                                     evidence = (Periodo_Curso == 3))

```





## Gerar BN para modelo simples para os períodos - teste
```{r}
disciplinas_primeiro_periogo = c("1411174", "1411180", "1411167")
disciplinas_segundo_periogo = c("1109113", "1411168", "1411181", "1411170")
disciplinas_terceiro_periogo = c("1411179", "1411176", "1411171", "1411172")

fittedbn <- bn.fit(res, data = df_alunos_cc, method="mle")

prob_reprovar_2nd_per_simples = cpquery(fittedbn, 
                                          event = (Situacao == "Reprovado"), 
                                          evidence = (Cod_Disciplina == "1411167" & 
                                                        Media_Int == 0))


prob_reprovar_3rd_per_simples = cpquery(fittedbn, 
                                          event = (Situacao == "Reprovado"), 
                                          evidence = (Cod_Disciplina %in% disciplinas_terceiro_periogo))

```

